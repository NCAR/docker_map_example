<!DOCTYPE html>
<html>
<head>
  <title>miles-credit</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }

    img {
      width: 90%;
      max-width: 900px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

<div class="page-container">
  <div class="sidebar">
    <h3>Datasets</h3>
    <div id="datasetList">
      {% for d in datasets %}
        <div class="dataset-row" data-dataset="{{ d }}">
          <input type="checkbox" name="dataset" class="dataset-check" value="{{ d }}">
          <span class="dataset-label">{{ d }}</span>
        </div>
      {% endfor %}
    </div>
    <!-- Parameters subsection -->
    <div id="datasetParams">
      <h3>Dataset Parameters</h3>
      <div id="paramsContent">
        <p>No dataset selected.</p>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div id="plotGrid" class="plot-grid"></div>
      <!--<h2 id="datasetHeader" class="dataset-header">
        No dataset selected
      </h2>
      <div class="widget-row">
        <label for="dimSelect">Dimension:</label>
        <select id="dimSelect">
          <option value="2d">2D</option>
          <option value="3d">3D</option>
        </select>
      
        <label for="variableSelect">Variable:</label>
        <select id="variableSelect"></select>
      </div>
      
      <div class="widget-row">
        <label for="timeSlider">Time:</label>
        <span id="timeValue">0</span>
        <input 
          type="range"
          id="timeSlider" 
          min="0"
          max="{{ ntime -1 }}"
          value="0"
          step="1"
        />
      
        <label for="levSlider">Level:</label>
        <span id="levValue">0</span>
        <input 
          type="range"
          id="levSlider"
          min="0"
          max="{{ nlev -1 }}"
          value="0"
          step="1"
        />
      </div>
      <img id="plotImage" src="/era5/plot?t=0" />-->
    </div>
  </div>
</div>

  <!--<script src="{{ url_for('static', filename='js/map/main.js') }}"></script>-->

  <script>
    console.log("test console");
    document.addEventListener("DOMContentLoaded", () => {
      const vars2d = {{ vars_2d | tojson }};
      const vars3d = {{ vars_3d | tojson }};
      const plottedDatasets = new Set();
      const panels = {}; // store panel DOM for each dataset
    
      // Grid container
      const grid = document.getElementById("plotGrid");
    
      // Checkbox setup
      document.querySelectorAll(".dataset-row").forEach(row => {
        const checkbox = row.querySelector(".dataset-check");
        const datasetName = row.dataset.dataset;
    
        // Row highlight
        row.addEventListener("click", () => {
          document.querySelectorAll(".dataset-row").forEach(r => r.classList.remove("active"));
          row.classList.add("active");
          updateParamsPanel(paramsDataset);
        });
    
        // Checkbox adds/removes panel
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            plottedDatasets.add(datasetName);
            // create panel if doesn't exist
            if (!panels[datasetName]) {
              panels[datasetName] = createPlotPanel(datasetName);
              grid.appendChild(panels[datasetName]);
            } else {
              panels[datasetName].style.display = "block";
            }
          } else {
            plottedDatasets.delete(datasetName);
            if (panels[datasetName]) panels[datasetName].style.display = "none";
          }
    
          updateGridLayout();
        });
      });
   
      function updateParamsPanel(datasetName) {
        const paramsDiv = document.getElementById("paramsContent");
      
        if (!datasetName) {
          paramsDiv.innerHTML = "<p>No dataset selected.</p>";
          return;
        }
        // Metadata display 
        paramsDiv.innerHTML = `
          <div class="param-grid">
            <div class="label">Name:</div><div class="value">${datasetName}</div>
            <div class="label">Ts Start:</div><div class="value">{{ stime }}</div>
            <div class="label">Ts End:</div><div class="value">{{ etime }}</div>
            <div class="label">Latitudes:</div><div class="value">{{ nlat }}</div>
            <div class="label">Longitudes:</div><div class="value">{{ nlon }}</div>
            <div class="label">Levels:</div><div class="value">{{ nlev }}</div>
            <div class="label">P-Levels:</div><div class="value">{{ nplev }}</div>
            <div class="label">Forecasts:</div><div class="value">{{ ntime }}</div>
          </div>
        `;
      }

      // Compute grid columns
      function computeGridColumns(n) {
        if (n <= 1) return 1;
        if (n <= 2) return 2;
        if (n <= 4) return 2;
        if (n <= 9) return 3;
        return 4;
      }
    
      // Update grid layout based on visible panels
      function updateGridLayout() {
        const visibleCount = Array.from(Object.values(panels)).filter(p => p.style.display !== "none").length;
        const cols = computeGridColumns(visibleCount);
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      }
    
      // Create a panel (only called once per dataset)
      function createPlotPanel(datasetName) {
        const panel = document.createElement("div");
        panel.className = "plot-panel";
    
        // Title
        const title = document.createElement("h3");
        title.textContent = datasetName;
    
        // Dimension selector
        const dimSelect = document.createElement("select");
        dimSelect.innerHTML = `<option value="2d">2D</option><option value="3d">3D</option>`;
    
        // Variable selector
        const varSelect = document.createElement("select");
    
        function populateVariables() {
          const dim = dimSelect.value;
          const vars = dim === "2d" ? vars2d : vars3d;
          varSelect.innerHTML = "";
          vars.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            varSelect.appendChild(opt);
          });
        }
    
        // Sliders
        const timeSlider = document.createElement("input");
        timeSlider.type = "range";
        timeSlider.min = 0;
        timeSlider.max = {{ ntime - 1 }};
        timeSlider.value = 0;
    
        const levSlider = document.createElement("input");
        levSlider.type = "range";
        levSlider.min = 0;
        levSlider.max = {{ nlev - 1 }};
        levSlider.value = 0;
    
        // Controls container
        const controls = document.createElement("div");
        controls.className = "plot-controls";
        const row1 = document.createElement("div");
        row1.className = "widget-row";
        const dimLabel = document.createElement("label");
        dimLabel.textContent = "Dimension:";
        const varLabel = document.createElement("label");
        varLabel.textContent = "Variable:";
        row1.appendChild(dimLabel);
        row1.appendChild(dimSelect);
        row1.appendChild(varLabel);
        row1.appendChild(varSelect);

        const row2 = document.createElement("div");
        row2.className = "widget-row";
        const timeLabel = document.createElement("label");
        //timeLabel.textContent = `Time:${timeSlider.value}`;
        const levLabel = document.createElement("label");
        //levLabel.textContent = `Level:${levSlider.value}`;
        row2.appendChild(timeLabel);
        row2.appendChild(timeSlider);
        row2.appendChild(levLabel);
        row2.appendChild(levSlider);

        controls.appendChild(row1);
        controls.appendChild(row2);
        // Plot image
        const img = document.createElement("img");
    
        function updatePlot() {
          timeLabel.textContent = `Time: ${timeSlider.value}`;
          levLabel.textContent = `Level: ${levSlider.value}`;
          img.src =
            `/era5/plot?dataset=$Name}` +
            `&t=${timeSlider.value}` +
            `&lev=${levSlider.value}` +
            `&var=${varSelect.value}`;
        }
    
        // Event listeners
        dimSelect.addEventListenee", () => {
          populateVariables();
          updatePlot();
        });
        varSelect.addEventListenee", updatePlot);
        timeSlider.addEventListent", updatePlot);
        levSlider.addEventListene", updatePlot);
    
        populateVariables();
        updatePlot();
    

        //controls.appendChild(doreateTextNode("Dimension:"));
        //controls.appendChild(di;
        //controls.appendChild(doreateTextNode("Variable:"));
        //controls.appendChild(va;
        //controls.appendChild(doreateTextNode("Time:"));
        //controls.appendChild(ti);
        //controls.appendChild(doreateTextNode("Level:"));
        //controls.appendChild(le;
    
        // Build panel
        panel.appendChild(title);
        panel.appendChild(controls);
        panel.appendChild(img);
    
        return panel;
      }
    });

//      const vars2d = {{ vars_2d | tojson }};
//      const vars3d = {{ vars_3d | tojson }};
//      const panels = {};
//
//      let paramsDataset = null;
//      let plottedDatasets = new Set();
//
//      const grid = document.getElementById("plotGrid");
//
//      //const datasetHeader = document.getElementById("datasetHeader");      
//      //const timeSlider    = document.getElementById("timeSlider");
//      //const levSlider     = document.getElementById("levSlider");
//      //const plotImage     = document.getElementById("plotImage");
//      //const timeValue     = document.getElementById("timeValue");
//      //const levValue      = document.getElementById("levValue");
//
//      //const dimSelect = document.getElementById("dimSelect");
//      //const variableSelect = document.getElementById("variableSelect");
//  
//      function populateVariables() {
//        const dim = dimSelect.value;
//        const vars = (dim === "2d") ? vars2d : vars3d;
//        variableSelect.innerHTML = "";
//        vars.forEach(v => {
//          const opt = document.createElement("option");
//          opt.value = v;
//          opt.textContent = v;
//          variableSelect.appendChild(opt);
//        });
//        updatePlot();
//      }
//
//      function computeGridColumns(n) {
//        if (n <= 1) return 1;
//        if (n <= 2) return 2;
//        if (n <= 4) return 2;   // quadrants
//        if (n <= 9) return 3;   // 3Ã—3
//        return 4;               // fallback
//      }
//
//      function createPlotPanel(datasetName) {
//        const panel = document.createElement("div");
//        panel.className = "plot-panel";
//        // ---- Title ----
//        const title = document.createElement("h3");
//        title.textContent = datasetName;
//        // Dimension selector (2D/3D)
//        const dimSelect = document.createElement("select");
//        dimSelect.innerHTML = `
//          <option value="2d">2D</option>
//          <option value="3d">3D</option>
//        `;
//        // ---- Variable Selector ----
//        const varSelect = document.createElement("select");
//        function populateVariables() {
//          const dim = dimSelect.value;
//          const vars = (dim === "2d") ? vars2d : vars3d;
//          varSelect.innerHTML = "";
//          vars.forEach(v => {
//            const opt = document.createElement("option");
//            opt.value = v;
//            opt.textContent = v;
//            varSelect.appendChild(opt);
//          });
//        }
//      
//        // ---- Time Slider ----
//        const timeSlider = document.createElement("input");
//        timeSlider.type = "range";
//        timeSlider.min = 0;
//        timeSlider.max = window.MAP_CONFIG.ntime - 1;
//        timeSlider.value = 0;
//      
//        // ---- Level Slider ----
//        const levSlider = document.createElement("input");
//        levSlider.type = "range";
//        levSlider.min = 0;
//        levSlider.max = window.MAP_CONFIG.nlev - 1;
//        levSlider.value = 0;
//      
//        // ---- Plot Image ----
//        const img = document.createElement("img");
//      
//        // ---- Update Function (LOCAL to panel) ----
//        function updatePanelPlot() {
//          img.src =
//            `/era5/plot?dataset=${datasetName}` +
//            `&t=${timeSlider.value}` +
//            `&lev=${levSlider.value}` +
//            `&var=${varSelect.value}`;
//        }
//      
//        // Attach events (panel-local!)
//        dimSelect.addEventListener("change", () => {
//          populateVariables();
//          updatePanelPlot();
//        });
//        varSelect.addEventListener("change", updatePanelPlot);
//        timeSlider.addEventListener("input", updatePanelPlot);
//        levSlider.addEventListener("input", updatePanelPlot);
//      
//        // Initial plot render
//        populateVariables();
//        updatePanelPlot();
//      
//        // ---- Controls Container ----
//        const controls = document.createElement("div");
//        controls.className = "plot-controls";
//        controls.appendChild(document.createTextNode("Dimension:"));
//        controls.appendChild(dimSelect); 
//        controls.appendChild(document.createTextNode("Variable:"));
//        controls.appendChild(varSelect);
//        controls.appendChild(document.createTextNode("Time:"));
//        controls.appendChild(timeSlider);
//        controls.appendChild(document.createTextNode("Level:"));
//        controls.appendChild(levSlider);
//      
//        // Build panel
//        panel.appendChild(title);
//        panel.appendChild(controls);
//        panel.appendChild(img);
//      
//        return panel;
//      }
//
//
//      function updatePlotGrid() {
//        const selected = Array.from(plottedDatasets);
//        const grid = document.getElementById("plotGrid");
//      
//        grid.innerHTML = "";
//      
//        if (selected.length === 0) return;
//      
//        //const cols = computeGridColumns(selected.length);
//        //grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
//        grid.style.gridTemplateColumns = `repeat(${computeGridColumns(selected.length)}, 1fr)`;
//      
//        selected.forEach(datasetName => {
//          const panel = createPlotPanel(datasetName);
//          grid.appendChild(panel);
//        });
//      }
//
//      function updatePlot() {
//        const header = plottedDatasets.values().next().value;
//        const t = parseInt(timeSlider.value);
//        const lev = parseInt(levSlider.value);
//        const varName = variableSelect.value;
//        timeValue.textContent = t;
//        levValue.textContent = lev;
//        // Force reload by adding timestamp to bypass browser caching
//        //plotImage.src = `/era5/plot?` +
//        //  `&dataset=${selectedDataset}` +
//        datasetHeader.textContent = header;
//        plotImage.src = `/era5/plot?` +
//          `&dataset=${header}` +
//          `&t=${t}` +
//          `&lev=${lev}` +
//          `&var=${varName}`;
//          //`&var=${varName}` +
//          //`&_=${new Date().getTime()}`;
//      }
//
//      function updateDatasetHighlight() {
//        document.querySelectorAll(".dataset-row").forEach(row => {
//          row.classList.remove("active");
//        });
//        //if (selectedDataset) {
//        if (paramsDataset) {
//          const activeRow = document.querySelector(
//            //`.dataset-row[data-dataset="${selectedDataset}"]`
//            `.dataset-row[data-dataset="${paramsDataset}"]`
//          );
//          if (activeRow) {
//            activeRow.classList.add("active");
//          }
//        }
//      }
//
//      function updateParamsPanel(datasetName) {
//        const paramsDiv = document.getElementById("paramsContent");
//      
//        if (!datasetName) {
//          paramsDiv.innerHTML = "<p>No dataset selected.</p>";
//          return;
//        }
//     
//        // Metadata display 
//        paramsDiv.innerHTML = `
//          <div class="param-grid">
//            <div class="label">Name:</div><div class="value">${datasetName}</div>
//            <div class="label">Ts Start:</div><div class="value">{{ stime }}</div>
//            <div class="label">Ts End:</div><div class="value">{{ etime }}</div>
//            <div class="label">Latitudes:</div><div class="value">{{ nlat }}</div>
//            <div class="label">Longitudes:</div><div class="value">{{ nlon }}</div>
//            <div class="label">Levels:</div><div class="value">{{ nlev }}</div>
//            <div class="label">P-Levels:</div><div class="value">{{ nplev }}</div>
//            <div class="label">Forecasts:</div><div class="value">{{ ntime }}</div>
//          </div>
//        `;
//      }
//
//      document.querySelectorAll(".dataset-row").forEach(row => {
//        const checkbox = row.querySelector(".dataset-check");
//        const datasetName = row.dataset.dataset;
//        
//        // Row click highlights + shows parameters
//        row.addEventListener("click", () => {
//          console.log("dataset-row clicked:", datasetName);
//          document.querySelectorAll(".dataset-row").forEach(r => r.classList.remove("active"));
//          row.classList.add("active");
//      
//          //selectedDataset = datasetName;
//          paramsDataset = datasetName;
//          //updateParamsPanel(selectedDataset);
//          updateParamsPanel(paramsDataset);
//        });
//      
//        // Checkbox controls only plotting (single selection)
//        checkbox.addEventListener("change", () => {
//          console.log("checkbox clicked:", checkbox);
//          if (checkbox.checked) {
//            plottedDatasets.add(datasetName);
//          } else {
//            plottedDatasets.delete(datasetName);
//          }
//          updatePlotGrid();
//          //if (checkbox.checked) {
//          //  document.querySelectorAll(".dataset-check").forEach(cb => {
//          //    if (cb !== checkbox) cb.checked = false;
//          //  });
//          //  plottedDatasets.clear();
//          //  plottedDatasets.add(datasetName);
//          //} else {
//          //  plottedDatasets.delete(datasetName);
//          //}
//          //updatePlot();
//        });
//      });

      // Auto select first dataset
      //const first = document.querySelector("input[name='dataset']");
      //if (first) {
      //  first.checked = true;
      //  //selectedDataset = first.value;
      //  plottedDatasets.add(first.value);
      //  updatePlot();
      //}

      //timeSlider.addEventListener("change", updatePlot);
      //timeSlider.addEventListener("input", () => {timeValue.textContent = timeSlider.value;});
      //levSlider.addEventListener("change", updatePlot);
      //levSlider.addEventListener("input", () => {levValue.textContent = levSlider.value;});

      //variableSelect.addEventListener("change", updatePlot);
      //dimSelect.addEventListener("change", populateVariables);

      //populateVariables();
    //});
  </script>

</body>
</html>
