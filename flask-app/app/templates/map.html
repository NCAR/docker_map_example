<!DOCTYPE html>
<html>
<head>
  <title>miles-credit</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }

    img {
      width: 90%;
      max-width: 900px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>

<div class="page-container">
  <div class="sidebar">
    <h3>Datasets</h3>
    <div id="datasetList">
      {% for d in datasets %}
        <div class="dataset-row" data-dataset="{{ d }}">
          <input type="checkbox" name="dataset" class="dataset-check" value="{{ d }}">
          <span class="dataset-label">{{ d }}</span>
        </div>
      {% endfor %}
    </div>
    <!-- Parameters subsection -->
    <div id="datasetParams">
      <h3>Dataset Parameters</h3>
      <div id="paramsContent">
        <p>No dataset selected.</p>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div id="plotGrid" class="plot-grid"></div>
    </div>
  </div>
</div>

  <!--<script src="{{ url_for('static', filename='js/map/main.js') }}"></script>-->

  <script>
    console.log("test console");
    document.addEventListener("DOMContentLoaded", () => {
      const metadata = {{ dataset_meta | tojson | safe }};
      const vars2d = {{ vars_2d | tojson }};
      const vars3d = {{ vars_3d | tojson }};
      const plottedDatasets = new Set();
      const panels = {}; // store panel DOM for each dataset
    
      // Grid container
      const grid = document.getElementById("plotGrid");
    
      // Checkbox setup
      document.querySelectorAll(".dataset-row").forEach(row => {
        const checkbox = row.querySelector(".dataset-check");
        const datasetName = row.dataset.dataset;
    
        // Row highlight
        row.addEventListener("click", () => {
          document.querySelectorAll(".dataset-row").forEach(r => r.classList.remove("active"));
          row.classList.add("active");
          //updateParamsPanel(paramsDataset);
          updateParamsPanel(datasetName);
        });
    
        // Checkbox adds/removes panel
        checkbox.addEventListener("change", () => {
          if (checkbox.checked) {
            plottedDatasets.add(datasetName);
            // create panel if doesn't exist
            if (!panels[datasetName]) {
              panels[datasetName] = createPlotPanel(datasetName);
              grid.appendChild(panels[datasetName]);
            } else {
              panels[datasetName].style.display = "block";
            }
          } else {
            plottedDatasets.delete(datasetName);
            if (panels[datasetName]) panels[datasetName].style.display = "none";
          }
    
          updateGridLayout();
        });
      });
   
      function updateParamsPanel(datasetName) {
        const paramsDiv = document.getElementById("paramsContent");
      
        if (!datasetName) {
          paramsDiv.innerHTML = "<p>No dataset selected.</p>";
          return;
        }
        // Metadata display 
        const data = metadata[datasetName]
        paramsDiv.innerHTML = `
          <div class="param-grid">
            <div class="label">Name:</div><div class="value">${datasetName}</div>
            <div class="label">Ts Start:</div><div class="value">${data.stime}</div>
            <div class="label">Ts End:</div><div class="value">${data.etime}</div>
            <div class="label">Latitudes:</div><div class="value">${data.nlat}</div>
            <div class="label">Longitudes:</div><div class="value">${data.nlon}</div>
            <div class="label">Levels:</div><div class="value">${data.nlev}</div>
            <div class="label">P-Levels:</div><div class="value">${data.nplev}</div>
            <div class="label">Forecasts:</div><div class="value">${data.ntime}</div>
          </div>
        `;
        //paramsDiv.innerHTML = `
        //  <div class="param-grid">
        //    <div class="label">Name:</div><div class="value">${datasetName}</div>
        //    <div class="label">Ts Start:</div><div class="value">{{ stime }}</div>
        //    <div class="label">Ts End:</div><div class="value">{{ etime }}</div>
        //    <div class="label">Latitudes:</div><div class="value">{{ nlat }}</div>
        //    <div class="label">Longitudes:</div><div class="value">{{ nlon }}</div>
        //    <div class="label">Levels:</div><div class="value">{{ nlev }}</div>
        //    <div class="label">P-Levels:</div><div class="value">{{ nplev }}</div>
        //    <div class="label">Forecasts:</div><div class="value">{{ ntime }}</div>
        //  </div>
        //`;
      }

      // Compute grid columns
      function computeGridColumns(n) {
        if (n <= 1) return 1;
        if (n <= 2) return 2;
        if (n <= 4) return 2;
        if (n <= 9) return 3;
        return 4;
      }
    
      // Update grid layout based on visible panels
      function updateGridLayout() {
        const visibleCount = Array.from(Object.values(panels)).filter(p => p.style.display !== "none").length;
        const cols = computeGridColumns(visibleCount);
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
      }
    
      // Create a panel (only called once per dataset)
      function createPlotPanel(datasetName) {
        const panel = document.createElement("div");
        panel.className = "plot-panel";
    
        // Title
        const title = document.createElement("h3");
        title.textContent = datasetName;
    
        // Dimension selector
        const dimSelect = document.createElement("select");
        dimSelect.innerHTML = `<option value="2d">2D</option><option value="3d">3D</option>`;
    
        // Variable selector
        const varSelect = document.createElement("select");
    
        function populateVariables() {
          const dim = dimSelect.value;
          const vars = dim === "2d" ? vars2d : vars3d;
          varSelect.innerHTML = "";
          vars.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            varSelect.appendChild(opt);
          });
        }
    
        // Sliders
        const timeSlider = document.createElement("input");
        timeSlider.type = "range";
        timeSlider.min = 0;
        timeSlider.max = {{ ntime - 1 }};
        timeSlider.value = 0;
    
        const levSlider = document.createElement("input");
        levSlider.type = "range";
        levSlider.min = 0;
        levSlider.max = {{ nlev - 1 }};
        levSlider.value = 0;
    
        // Controls container
        const controls = document.createElement("div");
        controls.className = "plot-controls";
        const row1 = document.createElement("div");
        row1.className = "widget-row";
        const dimLabel = document.createElement("label");
        dimLabel.textContent = "Dimension:";
        const varLabel = document.createElement("label");
        varLabel.textContent = "Variable:";
        row1.appendChild(dimLabel);
        row1.appendChild(dimSelect);
        row1.appendChild(varLabel);
        row1.appendChild(varSelect);

        const row2 = document.createElement("div");
        row2.className = "widget-row";
        const timeLabel = document.createElement("label");
        const levLabel = document.createElement("label");
        row2.appendChild(timeLabel);
        row2.appendChild(timeSlider);
        row2.appendChild(levLabel);
        row2.appendChild(levSlider);

        controls.appendChild(row1);
        controls.appendChild(row2);
        // Plot image
        const img = document.createElement("img");
    
        function updatePlot() {
          const is3D = dimSelect.value == "3d";
          levSlider.classList.toggle("hidden", !is3D);
          levLabel.classList.toggle("hidden", !is3D);
          if(is3D) levLabel.textContent = `Level: ${levSlider.value}`;

          timeLabel.textContent = `Time: ${timeSlider.value}`;

          img.src =
            `/era5/plot?dataset=${datasetName}` +
            `&t=${timeSlider.value}` +
            `&lev=${levSlider.value}` +
            `&var=${varSelect.value}`;
        }
    
        // Event listeners
        dimSelect.addEventListener("change", () => {
          populateVariables();
          updatePlot();
        });
        varSelect.addEventListener("change", updatePlot);
        timeSlider.addEventListener("input", updatePlot);
        levSlider.addEventListener("input", updatePlot);
    
        populateVariables();
        updatePlot();
    
        // Build panel
        panel.appendChild(title);
        panel.appendChild(controls);
        panel.appendChild(img);
    
        return panel;
      }
    });
  </script>
</body>
</html>
